#!/bin/bash
#VTUNE=/opt/intel/vtune_amplifier_xe_2011/bin64/amplxe-cl
VTUNE=amplxe-cl
SYMBOL="/usr/lib/debug/boot/$(uname -r)"
RDIR=vtune.$$
ROPT="-result-dir=$RDIR"
REPORT="-R hw-events -csv-delimiter tab"
#COLLECT="-analyze-system -collect nehalem_general-exploration -start-paused"
COLLECT="-collect nehalem-general-exploration -start-paused"
#COLLECT="-collect nehalem_general-exploration -start-paused"
SOPT="-search-dir all=$SYMBOL";

trap '' EXIT 

THREADS=""
while getopts ":t:" opt; do
  case $opt in
    t) THREADS=$OPTARG ;;
    :) echo "Option -t requires argument" >&2; exit 1 ;;
  esac
done

shift $((OPTIND-1))

rm -rf "$RDIR"
mkdir -p "$RDIR"

if [[ -z "$THREADS" ]]; then
  $VTUNE $COLLECT $ROPT $SOPT -- $*
else
  $VTUNE $COLLECT $ROPT $SOPT -- $* -t $THREADS
fi
R=$?

if (( $R )); then
  rm -rf "$RDIR"
  exit $R
fi

echo "RUN: CUT START"
$VTUNE $REPORT $ROPT -group-by function 2> /dev/null
R=$?
echo "RUN: CUT STOP"
rm -rf "$RDIR"
if (( $R )); then
  echo 'RUN: Variable VtuneError = 1' 1>&2
  exit $R
fi
